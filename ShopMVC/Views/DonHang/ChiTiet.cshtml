@model ShopMVC.Models.DonHang
@using ShopMVC.Models

@{
    ViewData["Title"] = "Chi tiết đơn #" + Model.MaDon;

    // Logic trạng thái đơn hàng
    var listTrangThai = new[] { TrangThaiDonHang.ChoXacNhan, TrangThaiDonHang.ChuanBi, TrangThaiDonHang.DangGiao, TrangThaiDonHang.HoanTat };
    int currentStep = 0;
    if (Model.TrangThai == TrangThaiDonHang.DaHuy) { currentStep = -1; }
    else if (Model.TrangThai == TrangThaiDonHang.HoanTat) { currentStep = 4; }
    else { currentStep = Array.IndexOf(listTrangThai, Model.TrangThai) + 1; }

    // Danh sách Id sản phẩm đã đánh giá
    var reviewedIds = ViewBag.ReviewedProductIds as List<int> ?? new List<int>();
}

@section Styles {
    <style>
        body {
            background-color: #f5f5fa;
        }

        /* Stepper */
        .steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            position: relative;
        }

            .steps::before {
                content: "";
                position: absolute;
                top: 15px;
                left: 0;
                width: 100%;
                height: 3px;
                background: #e0e0e0;
                z-index: 0;
            }

        .step {
            position: relative;
            z-index: 1;
            text-align: center;
            width: 25%;
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #fff;
            line-height: 32px;
            margin: 0 auto 8px;
            font-weight: bold;
            transition: 0.3s;
            font-size: 14px;
        }

        .step.active .step-icon {
            background: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
        }

        .step.active ~ .step .step-icon {
            background: #e0e0e0;
        }

        .step-text {
            font-size: 0.8rem;
            color: #999;
            font-weight: 500;
        }

        .step.active .step-text {
            color: #28a745;
            font-weight: 700;
        }

        /* Card Styles */
        .card-box {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card-header-custom {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            background: #fff;
        }

        .card-body-custom {
            padding: 1.5rem;
        }

        /* Product Table */
        .table-custom th {
            border-top: none;
            color: #888;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .table-custom td {
            vertical-align: middle;
            padding: 1rem 0.5rem;
        }

        .img-thumb {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        /* Right Column Info */
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
            font-size: 0.9rem;
            color: #555;
        }

            .info-row.total {
                font-size: 1.1rem;
                color: #000;
                font-weight: bold;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px dashed #ddd;
            }

        .customer-info i {
            width: 20px;
            text-align: center;
            color: #aaa;
            margin-right: 8px;
        }
    </style>
}

<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1">Chi tiết đơn hàng #@Model.MaDon</h4>
            <span class="text-muted small">Ngày đặt: @Model.NgayDat.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
        </div>
        <a asp-action="CuaToi" class="btn btn-white border shadow-sm btn-sm fw-bold">
            <i class="bi bi-chevron-left"></i> Quay lại
        </a>
    </div>

    @if (TempData["toast"]?.ToString() == "Đặt hàng thành công!")
    {
        <div class="alert alert-success d-flex align-items-center shadow-sm border-0 rounded-3 mb-4" role="alert">
            <i class="bi bi-check-circle-fill fs-4 me-3"></i>
            <div>
                <h6 class="fw-bold mb-0">Đặt hàng thành công!</h6>
                <p class="mb-0 small">Cảm ơn bạn đã tin tưởng. Chúng tôi sẽ sớm giao hàng cho bạn.</p>
            </div>
        </div>
    }

    @if (Model.TrangThai != TrangThaiDonHang.DaHuy)
    {
        <div class="card-box py-4 px-3">
            <div class="steps">
                <div class="step @(currentStep >= 1 ? "active" : "")">
                    <div class="step-icon"><i class="bi bi-file-text"></i></div>
                    <div class="step-text">Đã đặt đơn</div>
                </div>
                <div class="step @(currentStep >= 2 ? "active" : "")">
                    <div class="step-icon"><i class="bi bi-box-seam"></i></div>
                    <div class="step-text">Đang chuẩn bị</div>
                </div>
                <div class="step @(currentStep >= 3 ? "active" : "")">
                    <div class="step-icon"><i class="bi bi-truck"></i></div>
                    <div class="step-text">Đang giao</div>
                </div>
                <div class="step @(currentStep >= 4 ? "active" : "")">
                    <div class="step-icon"><i class="bi bi-star-fill"></i></div>
                    <div class="step-text">Hoàn thành</div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-danger text-center mb-4 rounded-3 shadow-sm">
            <i class="bi bi-x-circle-fill me-2"></i> Đơn hàng này đã bị hủy.
        </div>
    }

    <div class="row g-4 align-items-start">
        <div class="col-lg-8">
            <div class="card-box h-100">
                <div class="card-header-custom">
                    <h6 class="mb-0 fw-bold">Kiện hàng (@Model.ChiTiets.Count sản phẩm)</h6>
                </div>
                <div class="card-body-custom pt-0">
                    <div class="table-responsive">
                        <table class="table table-custom mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 55%">Sản phẩm</th>
                                    <th class="text-center">Giá</th>
                                    <th class="text-center">Số lượng</th>
                                    <th class="text-end">Tạm tính</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ct in Model.ChiTiets)
                                {
                                    // Logic lấy ảnh
                                    string imgSrc = "/images/default-product.png";
                                    if (ct.SanPham != null && ct.SanPham.Anhs != null && ct.SanPham.Anhs.Any())
                                    {
                                        var anhChinh = ct.SanPham.Anhs.FirstOrDefault(x => x.LaAnhChinh);
                                        imgSrc = anhChinh != null ? anhChinh.Url : ct.SanPham.Anhs.First().Url;
                                    }

                                    bool reviewed = reviewedIds.Contains(ct.IdSanPham);

                                    <tr>
                                        <td>
                                            <div class="d-flex">
                                                <img src="@imgSrc" class="img-thumb flex-shrink-0" />
                                                <div class="ms-3">
                                                    <h6 class="mb-1" style="font-size: 0.95rem; line-height: 1.4;">
                                                        <a asp-controller="SanPham"
                                                           asp-action="ChiTiet"
                                                           asp-route-id="@ct.IdSanPham"
                                                           class="text-decoration-none">
                                                            @(ct.SanPham?.TenDayDu ?? "Sản phẩm đã xóa")
                                                        </a>
                                                    </h6>

                                                    @if (ct.SanPham != null && (!string.IsNullOrWhiteSpace(ct.SanPham.Mau)
                                                   || !string.IsNullOrWhiteSpace(ct.SanPham.ThuocTinh2)))
                                                    {
                                                        var attrs = new[]
                                                        {
                                                ct.SanPham.Mau,
                                                ct.SanPham.ThuocTinh2
                                                }
                                                        .Where(x => !string.IsNullOrWhiteSpace(x));

                                                        if (attrs.Any())
                                                        {
                                                            <div class="small text-muted bg-light d-inline-block px-2 py-1 rounded mt-1">
                                                                @string.Join(" · ", attrs)
                                                            </div>
                                                        }
                                                    }


                                                    @* Đánh giá sản phẩm *@
                                                    <div class="mt-2">
                                                        @if (Model.TrangThai == TrangThaiDonHang.HoanTat)
                                                        {
                                                            if (!reviewed)
                                                            {
                                                                <a asp-controller="DanhGia"
                                                                   asp-action="Tao"
                                                                   asp-route-idSanPham="@ct.IdSanPham"
                                                                   asp-route-idDonHang="@Model.Id"
                                                                   class="btn btn-sm btn-outline-primary rounded-pill px-3 py-1">
                                                                    <i class="bi bi-star"></i> Đánh giá
                                                                </a>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-success bg-opacity-10 text-success border border-success small">
                                                                    <i class="bi bi-check-all"></i> Đã đánh giá
                                                                </span>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted small">
                                                                Chỉ có thể đánh giá khi đơn hàng đã hoàn tất.
                                                            </span>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center">@ct.DonGia.ToString("n0")đ</td>
                                        <td class="text-center text-muted">
                                            x @ct.SoLuong
                                        </td>
                                        <td class="text-end fw-bold">@ct.ThanhTien.ToString("n0")đ</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                @if (Model.TrangThai == TrangThaiDonHang.ChoXacNhan)
                {
                    <div class="card-footer bg-white border-top p-3 text-end">
                        <button class="btn btn-outline-danger btn-sm px-4 fw-bold" data-bs-toggle="modal" data-bs-target="#modalHuyDon">Hủy đơn hàng</button>
                    </div>
                }
            </div>
        </div>

        <div class="col-lg-4 position-sticky" style="top: 90px;">

            <div class="card-box">
                <div class="card-header-custom">
                    <h6 class="mb-0 fw-bold">Địa chỉ nhận hàng</h6>
                </div>
                <div class="card-body-custom customer-info">
                    <p class="mb-2 fw-bold text-dark">@Model.HoTenNhan</p>
                    <p class="mb-2 text-muted small"><i class="bi bi-telephone"></i> @Model.DienThoaiNhan</p>
                    <p class="mb-0 text-muted small"><i class="bi bi-geo-alt"></i> @Model.DiaChiNhan</p>
                </div>
            </div>

            <div class="card-box">
                <div class="card-header-custom">
                    <h6 class="mb-0 fw-bold">Tổng cộng</h6>
                </div>
                <div class="card-body-custom">
                    <div class="info-row">
                        <span>Tạm tính</span>
                        <span>@Model.TongTruocGiam.ToString("n0")đ</span>
                    </div>
                    <div class="info-row">
                        <span>Phí vận chuyển</span>
                        <span>@Model.PhiVanChuyen.ToString("n0")đ</span>
                    </div>
                    @if (Model.TienGiam > 0)
                    {
                        <div class="info-row text-success">
                            <span>Voucher</span>
                            <span>-@Model.TienGiam.ToString("n0")đ</span>
                        </div>
                    }
                    <div class="info-row total align-items-center">
                        <span>Thành tiền</span>
                        <span class="text-danger fs-4">@Model.TongThanhToan.ToString("n0")đ</span>
                    </div>
                    <div class="mt-3 text-end">
                        <span class="badge bg-light text-muted border">Thanh toán khi nhận hàng (COD)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalHuyDon" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow rounded-4">
            <div class="modal-body text-center p-4">
                <div class="text-danger mb-3"><i class="bi bi-exclamation-circle fs-1"></i></div>
                <h5 class="fw-bold mb-2">Hủy đơn hàng?</h5>
                <p class="text-muted small mb-4">Bạn chắc chắn muốn hủy đơn hàng này chứ?</p>
                <form asp-action="HuyDon" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <textarea name="lyDoHuy" class="form-control bg-light border-0 mb-3 small" rows="2" placeholder="Lý do hủy (tùy chọn)"></textarea>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-danger fw-bold">Xác nhận hủy</button>
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Không</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
