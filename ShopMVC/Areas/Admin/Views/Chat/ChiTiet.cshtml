@model ShopMVC.Models.ChatSession
@using Microsoft.AspNetCore.Identity
@using ShopMVC.Models
@inject UserManager<NguoiDung> UserManager

@{
    ViewData["Title"] = "Chat với Session " + Model.Id;
    var chatUser = Model.UserId != null ? await UserManager.FindByIdAsync(Model.UserId) : null;
    var chatUserName = chatUser?.UserName ?? chatUser?.Email ?? Model.UserConnectionId;
}

<style>
    .chat-window {
        position: relative;
        width: 100%;
        height: 600px;
        display: flex;
        flex-direction: column;
        border: 1px solid #ddd;
        border-radius: 8px;
    }

    .chat-header {
        background-color: #ff69b4; /* Màu hồng */
        color: white;
        padding: 1rem;
        font-weight: bold;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }

    /* CSS cho box sản phẩm */
    .product-context-admin {
        background: #fff;
        border-bottom: 1px solid #ddd;
        padding: 1rem;
    }

        .product-context-admin p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .product-context-admin strong {
            font-size: 1rem;
            color: #000;
        }

    .chat-body {
        flex-grow: 1;
        padding: 1rem;
        overflow-y: auto;
        background: #f9f9f9;
        display: flex;
        flex-direction: column;
    }

    .chat-footer {
        padding: 1rem;
        border-top: 1px solid #ddd;
        display: flex;
        background: #fff;
    }

    .msg {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 18px;
        max-width: 80%;
    }

    .msg-user {
        background-color: #e9ecef; /* Tin nhắn của User (khách) - Xám nhạt */
        color: #333;
        align-self: flex-start;
    }

    .msg-admin {
        background-color: #ff69b4; /* Tin nhắn của Admin - Hồng */
        color: white;
        align-self: flex-end;
        margin-left: auto;
    }
</style>

<div class="chat-window">
    <div class="chat-header">
        Đang chat với: @chatUserName (Session: @Model.Id)
    </div>

    @if (Model.SanPham != null)
    {
        <div class="product-context-admin">
            <p>Khách đang hỏi về sản phẩm:</p>
            <strong>@Model.SanPham.TenDayDu</strong>
        </div>
    }

    <div class="chat-body" id="chatBodyAdmin">
        @foreach (var msg in Model.Messages.OrderBy(m => m.ThoiGian))
        {
            <div class="msg @(msg.Sender == SenderType.Admin ? "msg-admin" : "msg-user")">
                @msg.NoiDung
            </div>
        }
    </div>

    <div class="chat-footer">
        <input type="text" id="chatInputAdmin" class="form-control me-2" placeholder="Nhập tin nhắn..." />
        <button class="btn btn-primary" id="chatSendBtnAdmin"><i class="bi bi-send-fill"></i></button>
    </div>
</div>

@section Scripts {
    <script src="~/lib/signalr/signalr.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const chatBody = document.getElementById("chatBodyAdmin");
            const chatInput = document.getElementById("chatInputAdmin");
            const chatSendBtn = document.getElementById("chatSendBtnAdmin");

            const sessionId = @Model.Id;
            const userConnectionId = "@Model.UserConnectionId";

            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub?isAdmin=true")
                .build();

            // Nhận tin nhắn (từ user hoặc từ chính admin)
            connection.on("ReceiveMessage", (msgSessionId, sender, message) => {
                if (msgSessionId === sessionId) {
                    appendMessage(message, sender === "Admin" ? "msg-admin" : "msg-user");
                }
            });

            // Hàm thêm tin nhắn vào UI
            function appendMessage(message, cssClass) {
                const msgDiv = document.createElement("div");
                msgDiv.classList.add("msg", cssClass);
                msgDiv.textContent = message;
                chatBody.appendChild(msgDiv);
                chatBody.scrollTop = chatBody.scrollHeight;
            }

            // Hàm gửi tin nhắn
            async function sendMessage() {
                const message = chatInput.value.trim();
                if (message.length > 0) {
                    try {
                        await connection.invoke("SendMessageFromAdmin", sessionId, userConnectionId, message);
                        chatInput.value = "";
                    } catch (e) {
                        console.error(e.toString());
                    }
                }
            }

            // Gán sự kiện cho nút gửi và phím Enter
            chatSendBtn.addEventListener("click", sendMessage);
            chatInput.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    sendMessage();
                }
            });

            // Bắt đầu kết nối
            connection.start().catch(err => console.error(err.toString()));

            // Cuộn xuống cuối khi tải trang
            chatBody.scrollTop = chatBody.scrollHeight;
        });
    </script>
}